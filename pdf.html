<!DOCTYPE html>
<html lang="en" class="antialiased scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PDF Report - Blood Donation Community</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="shortcut icon" href="image/blood-drop.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/profile.css">
    <meta name="description" content="Generate and download monthly PDF donation reports.">
    <style>
        #page-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        #page-loader.fade-out { opacity: 0; visibility: hidden; transition: opacity .5s, visibility .5s; }
        body.loading > *:not(#page-loader):not(script) { opacity: 0 !important; visibility: hidden !important; }
        .pdf-page-main {
            min-height: calc(100vh - 80px); display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; padding: 2rem 1rem;
        }
        .pdf-hero { text-align: center; margin-bottom: 2rem; max-width: 600px; }
        .pdf-hero h1 { font-size: 1.5rem; font-weight: 800; color: #1f2937; }
        .pdf-hero p { font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem; }
        .pdf-card {
            width: 100%; max-width: 560px; background: #fff; border-radius: 1.25rem;
            padding: 2rem; box-shadow: 0 4px 24px rgba(0,0,0,0.06); border: 1px solid rgba(225,29,72,0.08);
        }
        .pdf-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .pdf-info-item { background: #fef2f2; border-radius: 0.75rem; padding: 1rem; text-align: center; }
        .pdf-info-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #ef4444; margin-bottom: 0.25rem; }
        .pdf-info-value { font-size: 1.1rem; font-weight: 800; color: #1f2937; }
        .pdf-generate-btn {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem; width: 100%;
            padding: 0.85rem 1.5rem; border-radius: 0.75rem; font-size: 0.95rem; font-weight: 700;
            background: linear-gradient(135deg,#b91c1c,#dc2626); color: #fff; border: none; cursor: pointer;
            box-shadow: 0 6px 20px rgba(185,28,28,0.25); transition: all 0.25s;
        }
        .pdf-generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(185,28,28,0.35); }
        .pdf-generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .pdf-generate-btn .spinner { display: none; width: 18px; height: 18px; border: 2.5px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }
        .pdf-generate-btn.generating .spinner { display: block; }
        .pdf-generate-btn.generating .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pdf-status { font-size: 0.8rem; color: #059669; text-align: center; margin-top: 1rem; font-weight: 600; display: none; }
        .pdf-status.show { display: block; }
        @media (max-width: 480px) {
            .pdf-page-main { padding: 1rem 0.5rem; }
            .pdf-card { padding: 1.25rem; }
            .pdf-info-grid { grid-template-columns: 1fr; gap: 0.75rem; }
            .pdf-hero h1 { font-size: 1.25rem; }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 loading" style="font-family:'Inter',sans-serif;">
    <div id="page-loader">
        <div class="logo-wrapper">
            <div class="logo-base"><img src="image/blood-drop.png" alt="" /></div>
            <div class="logo-fill"><img src="image/blood-drop.png" alt="Loading" /></div>
        </div>
    </div>

    <header class="profile-header">
        <nav class="max-w-5xl mx-auto flex items-center justify-between px-4 sm:px-6 py-3">
            <a href="index.html" class="flex items-center gap-2.5 text-decoration-none group">
                <img src="image/blood-drop.png" alt="logo" class="h-9 w-9 rounded-xl transition group-hover:scale-110" />
                <span class="text-lg sm:text-xl font-extrabold text-red-700 tracking-tight">PDF Report</span>
            </a>
            <div class="flex items-center gap-2">
                <a href="profile.html"
                    class="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-red-700 hover:bg-red-50 transition">
                    <i class="fa-solid fa-user text-xs"></i>
                    <span class="hidden sm:inline">Profile</span>
                </a>
                <a href="index.html"
                    class="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-red-700 hover:bg-red-50 transition">
                    <i class="fa-solid fa-arrow-left text-xs"></i>
                    <span class="hidden sm:inline">Home</span>
                </a>
            </div>
        </nav>
    </header>

    <main class="pdf-page-main">
        <div class="pdf-hero">
            <h1><i class="fa-solid fa-file-pdf text-red-500 mr-2"></i>Monthly Donation Report</h1>
            <p>Generate a comprehensive PDF report of all recent donations with statistics and details</p>
        </div>

        <div id="not-logged-in" class="hidden">
            <div class="profile-empty-state">
                <div class="profile-empty-icon"><i class="fa-solid fa-user-lock"></i></div>
                <h2 class="text-xl font-bold text-gray-800 mt-4">You're not logged in</h2>
                <p class="text-sm text-gray-500 mt-2 max-w-sm mx-auto">Please log in to generate reports.</p>
                <a href="index.html" class="mt-6 inline-flex items-center gap-2 px-6 py-2.5 rounded-lg bg-red-600 text-white font-semibold shadow hover:bg-red-700 transition">
                    <i class="fa-solid fa-arrow-left"></i> Go to Home
                </a>
            </div>
        </div>

        <div id="pdf-content" class="hidden">
            <div class="pdf-card">
                <div class="pdf-info-grid">
                    <div class="pdf-info-item">
                        <div class="pdf-info-label"><i class="fa-solid fa-droplet mr-1"></i>Total Donations</div>
                        <div class="pdf-info-value" id="pdf-total-count">0</div>
                    </div>
                    <div class="pdf-info-item">
                        <div class="pdf-info-label"><i class="fa-solid fa-calendar mr-1"></i>Report Period</div>
                        <div class="pdf-info-value" id="pdf-period" style="font-size:0.85rem;">—</div>
                    </div>
                    <div class="pdf-info-item">
                        <div class="pdf-info-label"><i class="fa-solid fa-users mr-1"></i>Unique Donors</div>
                        <div class="pdf-info-value" id="pdf-unique-donors">0</div>
                    </div>
                    <div class="pdf-info-item">
                        <div class="pdf-info-label"><i class="fa-solid fa-chart-bar mr-1"></i>Blood Groups</div>
                        <div class="pdf-info-value" id="pdf-blood-groups">0</div>
                    </div>
                </div>
                <button class="pdf-generate-btn" id="pdf-generate-btn">
                    <div class="spinner"></div>
                    <i class="fa-solid fa-file-pdf btn-text"></i>
                    <span class="btn-text">Generate & Download PDF</span>
                </button>
                <div class="pdf-status" id="pdf-status"><i class="fa-solid fa-circle-check mr-1"></i>PDF generated successfully!</div>
            </div>
        </div>
    </main>

    <script src="assets/js/viewport.js" defer></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { firebaseConfig } from "./assets/js/modules/firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const loader = document.getElementById('page-loader');

        function hideLoader() {
            if (loader) {
                loader.classList.add('fade-out');
                document.body.classList.remove('loading');
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            }
        }

        let recentDonations = [];

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                hideLoader();
                document.getElementById('not-logged-in')?.classList.remove('hidden');
                return;
            }

            // Check admin role
            const roleRef = ref(database, `donors/${user.uid}/role`);
            onValue(roleRef, (roleSnap) => {
                const role = roleSnap.val();
                if (role !== 'admin') {
                    hideLoader();
                    document.getElementById('not-logged-in')?.classList.remove('hidden');
                    const el = document.querySelector('.profile-empty-state h2');
                    if (el) el.textContent = 'Admin Access Required';
                    const desc = document.querySelector('.profile-empty-state p');
                    if (desc) desc.textContent = 'Only admins can generate monthly PDF reports.';
                    return;
                }

                // Load recent donations
                const recentRef = ref(database, 'recentDonations');
                onValue(recentRef, (snapshot) => {
                    const raw = snapshot.val();
                    recentDonations = raw ? (Array.isArray(raw) ? raw.filter(Boolean) : Object.values(raw).filter(Boolean)) : [];

                    hideLoader();
                    document.getElementById('pdf-content')?.classList.remove('hidden');

                    // Stats
                    document.getElementById('pdf-total-count').textContent = recentDonations.length;
                    const uniqueNames = new Set(recentDonations.map(d => (d.fullName || d.name || '').toLowerCase().trim()).filter(Boolean));
                    document.getElementById('pdf-unique-donors').textContent = uniqueNames.size;
                    const bloodGroups = new Set(recentDonations.map(d => d.bloodGroup).filter(Boolean));
                    document.getElementById('pdf-blood-groups').textContent = bloodGroups.size;

                    // Period
                    const dates = recentDonations.map(d => d.date || d.donationDate || '').filter(Boolean).sort();
                    if (dates.length > 0) {
                        const first = new Date(dates[0] + 'T00:00:00').toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                        const last = new Date(dates[dates.length-1] + 'T00:00:00').toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                        document.getElementById('pdf-period').textContent = first === last ? first : `${first} – ${last}`;
                    }
                }, { onlyOnce: true });
            }, { onlyOnce: true });
        });

        // Generate button
        document.getElementById('pdf-generate-btn')?.addEventListener('click', async function() {
            const btn = this;
            if (btn.disabled) return;
            btn.disabled = true;
            btn.classList.add('generating');

            try {
                const { loadJsPdf } = await import('./assets/js/modules/pdf-report.js');
                const jsPdfCtor = await loadJsPdf();
                if (!jsPdfCtor) throw new Error('jsPDF failed to load');

                const pdf = new jsPdfCtor({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pageW = pdf.internal.pageSize.getWidth();
                let y = 20;

                // Header
                pdf.setFillColor(185, 28, 28);
                pdf.rect(0, 0, pageW, 35, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(18);
                pdf.text('Blood Donation Community', pageW / 2, 15, { align: 'center' });
                pdf.setFontSize(11);
                pdf.text('Monthly Donation Report', pageW / 2, 25, { align: 'center' });
                pdf.setFontSize(8);
                pdf.text('Generated: ' + new Date().toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' }), pageW / 2, 32, { align: 'center' });

                y = 45;
                pdf.setTextColor(31, 41, 55);

                // Summary
                pdf.setFontSize(13);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Summary', 15, y);
                y += 8;
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Total Donations: ${recentDonations.length}`, 15, y); y += 6;
                const uniqueNames = new Set(recentDonations.map(d => (d.fullName || d.name || '').toLowerCase().trim()).filter(Boolean));
                pdf.text(`Unique Donors: ${uniqueNames.size}`, 15, y); y += 6;
                const bloodGroups = new Set(recentDonations.map(d => d.bloodGroup).filter(Boolean));
                pdf.text(`Blood Groups: ${[...bloodGroups].join(', ') || 'N/A'}`, 15, y); y += 10;

                // Divider
                pdf.setDrawColor(220, 38, 38);
                pdf.setLineWidth(0.5);
                pdf.line(15, y, pageW - 15, y);
                y += 8;

                // Donation table
                pdf.setFontSize(13);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Donation Details', 15, y);
                y += 8;

                // Table header
                pdf.setFillColor(254, 242, 242);
                pdf.rect(15, y - 4, pageW - 30, 8, 'F');
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(185, 28, 28);
                const cols = [15, 65, 95, 125, 165];
                pdf.text('Name', cols[0] + 2, y + 1);
                pdf.text('Blood', cols[1] + 2, y + 1);
                pdf.text('Date', cols[2] + 2, y + 1);
                pdf.text('Location', cols[3] + 2, y + 1);
                pdf.text('Phone', cols[4] + 2, y + 1);
                y += 8;

                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(55, 65, 81);
                pdf.setFontSize(7.5);

                recentDonations.forEach((d, i) => {
                    if (y > 270) { pdf.addPage(); y = 20; }
                    if (i % 2 === 0) {
                        pdf.setFillColor(249, 250, 251);
                        pdf.rect(15, y - 3.5, pageW - 30, 6, 'F');
                    }
                    pdf.text((d.fullName || d.name || '—').substring(0, 28), cols[0] + 2, y);
                    pdf.text(d.bloodGroup || '—', cols[1] + 2, y);
                    pdf.text(d.date || d.donationDate || '—', cols[2] + 2, y);
                    pdf.text((d.location || '—').substring(0, 18), cols[3] + 2, y);
                    pdf.text(d.phone || '—', cols[4] + 2, y);
                    y += 6;
                });

                // Footer
                y = Math.max(y + 10, 260);
                if (y > 270) { pdf.addPage(); y = 20; }
                pdf.setDrawColor(220, 38, 38);
                pdf.line(15, y, pageW - 15, y);
                y += 6;
                pdf.setFontSize(8);
                pdf.setTextColor(156, 163, 175);
                pdf.text('© 2026 Blood Donation Community — Donate Blood, Save Lives', pageW / 2, y, { align: 'center' });

                pdf.save(`BDC_Monthly_Report_${new Date().toISOString().slice(0,10)}.pdf`);

                const status = document.getElementById('pdf-status');
                if (status) { status.classList.add('show'); setTimeout(() => status.classList.remove('show'), 4000); }
            } catch (err) {
                console.error('PDF generation error:', err);
                alert('Failed to generate PDF. Please try again.');
            } finally {
                btn.disabled = false;
                btn.classList.remove('generating');
            }
        });
    </script>
</body>

</html>
